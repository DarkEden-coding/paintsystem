name: Release

on:
    pull_request:
        branches: ['**']
    workflow_dispatch:
        inputs:
            version:
                description: 'version'
                required: false # Make this optional
                default: ''

permissions:
    contents: write

jobs:
    Build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v3

            - name: Extract version from __init__.py
              id: extract_version
              run: |
                  # Extract the version tuple from __init__.py
                  VERSION=$(grep -oP '(?<=version = )\(.*?\)' path/to/__init__.py | tr -d '(), ' | tr '\n' '.')
                  if [[ -z "$VERSION" ]]; then
                    echo "Error: Version could not be extracted from __init__.py"
                    exit 1
                  fi
                  echo "VERSION=$VERSION"
                  echo "version=$VERSION" >> $GITHUB_ENV

            - name: Validate version
              id: validate_version
              run: |
                  if [[ -z "${{ env.version }}" ]]; then
                    echo "Error: Extracted version is invalid."
                    exit 1
                  else
                    echo "Extracted version: ${{ env.version }}"
                  fi

            - name: Build addon
              uses: blenderkit/blender-addon-build@main
              with:
                  name: paint-system
                  exclude-files: '.git;.github;README.md'

    Release:
        runs-on: ubuntu-latest
        needs: Build
        steps:
            - name: Checkout repository
              uses: actions/checkout@v3

            - name: Release addon
              uses: blenderkit/blender-addon-release@main
              with:
                  artifact_name: paint-system
                  release_name: Paint System
                  version: ${{ env.version }}
